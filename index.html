<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Huahin Properties | All Online Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css" />
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600&display=swap');
        body { font-family: 'Prompt', sans-serif; background-color: #8cabd9; -webkit-tap-highlight-color: transparent; }
        .line-bg-green { background-color: #06C755; }
        #detailPage { display: none; position: fixed; inset: 0; background: white; z-index: 150; overflow-y: auto; }
        #lightbox { display: none; position: fixed; inset: 0; background: black; z-index: 200; align-items: center; justify-content: center; }
        .suggested-scroll { display: flex; overflow-x: auto; gap: 10px; padding: 10px 0; }
        .suggested-item { flex: 0 0 calc(33.33% - 7px); }
        .loading-overlay { position: fixed; inset: 0; background: #8cabd9; display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 9999; }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
        .animate-house { animation: bounce 1.5s infinite ease-in-out; }
    </style>
</head>
<body class="pb-24">

    <div id="loadingScreen" class="loading-overlay">
        <div class="animate-house text-white mb-4"><svg class="w-16 h-16" fill="currentColor" viewBox="0 0 20 20"><path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011-1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z"></path></svg></div>
        <p class="text-white">กำลังโหลดข้อมูล 15 รูป...</p>
    </div>

    <header class="bg-white px-3 py-2 flex items-center justify-between sticky top-0 z-30 border-b shadow-sm">
        <div class="font-black text-blue-900 text-sm">HUAHIN PROPERTIES</div>
        <button onclick="liff.closeWindow()" class="text-gray-300"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg></button>
    </header>

    <main id="app" class="px-4 py-6 grid grid-cols-1 sm:grid-cols-2 gap-6"></main>

    <div id="detailPage">
        <button onclick="closeDetail()" class="fixed top-4 left-4 z-[160] bg-black/30 rounded-full p-2 text-white"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-width="2" d="M15 19l-7-7 7-7"></path></svg></button>
        <div id="detailContent"></div>
    </div>

    <div id="lightbox" onclick="this.style.display='none'">
        <div class="swiper lightboxSwiper w-full h-full">
            <div class="swiper-wrapper" id="lightboxWrapper"></div>
            <div class="swiper-pagination"></div>
        </div>
    </div>

    <div class="bg-white p-6 mt-10 border-t border-gray-200">
        <h3 class="font-bold mb-4">ส่วนแอดมิน: อัปโหลดรูปบ้าน (สูงสุด 15 รูป)</h3>
        <input type="text" id="adminPropId" placeholder="ใส่รหัสบ้าน (เช่น P001)" class="w-full mb-3 p-2 border rounded">
        <input type="file" id="adminFiles" multiple accept="image/*" class="text-sm">
        <button onclick="handleAdminUpload()" class="mt-4 w-full line-bg-green text-white p-3 rounded-xl font-bold">เริ่มอัปโหลดเข้า Google Drive</button>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>
    <script>
        const GAS_URL = "https://script.google.com/macros/s/AKfycbw1q-jxFZlTzLha-gis2bcVDdGQTenjzd6IpTj9XuvJbzBE5cL0_FN9i5myiRV5YGQY/exec"; 
        let allProperties = [];

        async function initLiff() {
            try {
                await liff.init({ liffId: "2008909867-tJ76yUtj" });
                if (!liff.isLoggedIn()) liff.login();
                loadData();
            } catch (err) { console.log(err); }
        }

        async function loadData() {
            document.getElementById('loadingScreen').style.display = 'flex';
            const res = await fetch(GAS_URL, { method: 'POST', body: JSON.stringify({ action: "aiSearch" }) });
            allProperties = await res.json();
            renderCards(allProperties);
            document.getElementById('loadingScreen').style.display = 'none';
        }

        function renderCards(properties) {
            const container = document.getElementById('app');
            container.innerHTML = properties.map(p => `
                <div class="bg-white rounded-2xl overflow-hidden shadow-md flex flex-col">
                    <img src="${p.ImageUrls.split(',')[0]}" class="h-52 w-full object-cover">
                    <div class="p-5">
                        <h2 class="font-bold text-lg mb-2">${p.Title}</h2>
                        <div class="flex justify-between items-center">
                            <span class="text-orange-600 font-black text-xl">฿${Number(p.Price).toLocaleString()}</span>
                            <button onclick="showDetail('${p.ID}')" class="bg-gray-100 px-4 py-2 rounded-full text-xs font-bold">ดูรายละเอียด</button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function showDetail(id) {
            const p = allProperties.find(item => item.ID == id);
            if (!p) return;
            document.getElementById('detailPage').style.display = 'block';
            document.body.style.overflow = 'hidden';

            const imageUrls = p.ImageUrls.split(',');
            const images = imageUrls.map(url => `<div class="swiper-slide" onclick="openLightbox()"><img src="${url.trim()}" class="w-full aspect-square object-cover shadow-lg"></div>`).join('');
            document.getElementById('lightboxWrapper').innerHTML = imageUrls.map(url => `<div class="swiper-slide flex items-center justify-center"><img src="${url.trim()}" class="max-w-full max-h-full"></div>`).join('');

            const suggestions = allProperties.filter(item => item.ID != id).slice(0, 6);
            const suggestionHtml = suggestions.map(s => `<div class="suggested-item" onclick="showDetail('${s.ID}')"><div class="bg-white rounded-lg overflow-hidden border border-gray-100"><img src="${s.ImageUrls.split(',')[0]}" class="w-full aspect-square object-cover"><div class="p-1.5"><p class="text-[9px] font-bold truncate">${s.Title}</p></div></div></div>`).join('');

            document.getElementById('detailContent').innerHTML = `
                <div class="swiper detailSwiper h-[400px] bg-gray-100">${images}</div>
                <div class="p-6 bg-white -mt-6 rounded-t-[40px] relative z-10">
                    <h1 class="text-2xl font-bold mb-2">${p.Title}</h1>
                    <p class="text-orange-600 text-3xl font-black mb-6">฿${Number(p.Price).toLocaleString()}</p>
                    <h3 class="font-bold border-b pb-2 mb-2">รายละเอียดโครงการ</h3>
                    <p class="text-gray-600 text-sm mb-10 leading-relaxed">${p.Description || 'พบกับบ้านหรูคุณภาพเยี่ยมที่หัวหิน'}</p>
                    <h3 class="font-bold mb-4">อสังหาฯ อื่นๆ ที่น่าสนใจ</h3>
                    <div class="suggested-scroll">${suggestionHtml}</div>
                </div>
            `;
            new Swiper(".detailSwiper", { pagination: true, loop: true });
            document.getElementById('detailPage').scrollTop = 0;
        }

        function openLightbox() {
            document.getElementById('lightbox').style.display = 'flex';
            new Swiper(".lightboxSwiper", { pagination: true, loop: true });
        }

        function closeDetail() { document.getElementById('detailPage').style.display = 'none'; document.body.style.overflow = 'auto'; }

        // --- ระบบอัปโหลด 15 รูป (Admin Logic) ---
        async function handleAdminUpload() {
            const propId = document.getElementById('adminPropId').value;
            const files = document.getElementById('adminFiles').files;
            if (!propId || files.length === 0) return alert("กรุณาใส่รหัสบ้านและเลือกรูป");
            if (files.length > 15) return alert("อัปโหลดได้สูงสุด 15 รูปครับ");

            document.getElementById('loadingScreen').style.display = 'flex';
            const filePromises = Array.from(files).map(file => {
                return new Promise(resolve => {
                    const reader = new FileReader();
                    reader.onload = (e) => resolve({ name: file.name, mimeType: file.type, data: e.target.result.split(',')[1] });
                    reader.readAsDataURL(file);
                });
            });

            const processedFiles = await Promise.all(filePromises);
            const res = await fetch(GAS_URL, { method: 'POST', body: JSON.stringify({ action: "uploadImages", propertyId: propId, files: processedFiles }) });
            const result = await res.json();
            if (result.status === "success") { alert("อัปโหลด 15 รูปและบันทึกลิงก์ลง Sheet สำเร็จ!"); location.reload(); }
        }

        initLiff();
    </script>
</body>
</html>
